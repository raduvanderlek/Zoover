function MLRemoteSearchController(t,e,n,r){"use strict";return this instanceof MLRemoteSearchController?(MLSearchController.call(this,t,e,n),void(this.remoteInput=r)):new MLRemoteSearchController(t,e,n,r)}function MLSearchController(t,e,n){"use strict";return this instanceof MLSearchController?(this.$scope=t,this.$location=e,this.mlSearch=n,this.searchPending=!1,this.page=1,this.qtext="",void(this.response={})):new MLSearchController(t,e,n)}!function(){"use strict";angular.module("ml.search",["ml.common"])}();var superCtrl=MLSearchController.prototype;MLRemoteSearchController.prototype=Object.create(superCtrl),function(){"use strict";MLRemoteSearchController.prototype.init=function(){var t=this,e=this.remoteInput.subscribe(function(e){t.qtext!==e&&(t.qtext=e,t.search.call(t))});return this.remoteInput.mlSearch=this.mlSearch,this.qtext=this.remoteInput.input,this.$scope.$on("$destroy",e),superCtrl.init.apply(this,arguments)},MLRemoteSearchController.prototype.updateSearchResults=function(t){return superCtrl.updateSearchResults.apply(this,arguments),this.remoteInput.setInput(this.qtext),this}}(),function(){"use strict";MLSearchController.prototype.init=function(){return this.$scope.$on("$locationChangeSuccess",this.locationChange.bind(this)),this.parseExtraURLParams&&this.parseExtraURLParams(),this.mlSearch.fromParams().then(this._search.bind(this))},MLSearchController.prototype.locationChange=function(t,e,n){var r=this,s=!1;return this.parseExtraURLParams&&(s=this.parseExtraURLParams()),this.mlSearch.locationChange(e,n).then(this._search.bind(this),function(){s&&r._search.call(r)})},MLSearchController.prototype._search=function(){this.searchPending=!0;var t=this.mlSearch.search().then(this.updateSearchResults.bind(this));return this.updateURLParams(),t},MLSearchController.prototype.updateSearchResults=function(t){return this.searchPending=!1,this.response=t,this.qtext=this.mlSearch.getText(),this.page=this.mlSearch.getPage(),this},MLSearchController.prototype.updateURLParams=function(){var t=_.chain(this.$location.search()).omit(this.mlSearch.getParamsKeys()).merge(this.mlSearch.getParams()).value();return this.$location.search(t),this.updateExtraURLParams&&this.updateExtraURLParams(),this},MLSearchController.prototype.search=function(t){return arguments.length&&(this.qtext=t),this.mlSearch.setText(this.qtext).setPage(this.page),this._search()},MLSearchController.prototype.reset=function(){return this.mlSearch.clearAllFacets().clearAdditionalQueries().clearBoostQueries(),this.qtext="",this.page=1,this._search()},MLSearchController.prototype.toggleFacet=function(t,e){return this.mlSearch.toggleFacet(t,e),this._search()},MLSearchController.prototype.toggleNegatedFacet=function(t,e){return this.mlSearch.toggleFacet(t,e,!0),this._search()},MLSearchController.prototype.showMoreFacets=function(t,e,n){return this.mlSearch.showMoreFacets(t,e,n)},MLSearchController.prototype.clearFacets=function(){return this.mlSearch.clearAllFacets(),this._search()},MLSearchController.prototype.suggest=function(t,e){return this.mlSearch.suggest(t,e).then(function(t){return t.suggestions||[]})}}(),function(){"use strict";function t(){return{restrict:"E",scope:{activeFacets:"=",toggle:"&"},templateUrl:e,link:n}}function e(t,e){var n;return n=e.template?e.template:"/templates/ml-chiclets.html"}function n(t,e,n){t.truncateLength=parseInt(n.truncate)||20}angular.module("ml.search").directive("mlChiclets",t)}(),function(){"use strict";function t(){return function(t,e){t=_.isObject(t)?t:r(t);var n=[],s={year:"year",years:"years",month:"month",months:"months",week:"week",weeks:"weeks",day:"day",days:"days",hour:"hour",hours:"hours",minute:"minute",minutes:"minutes",second:"second",seconds:"seconds"};if(angular.extend(s,e),_.each(["year","month","week","day","hour","minute","second"],function(e){var r=e+"s";t[r]&&n.push(t[r]+" "+(t[r]>1?s[r]:s[e]))}),n.length>1){var a=n.splice(n.length-1,1);return n=n.join(", ")+", and "+a[0]}return n[0]||"0 seconds"}}function e(){return{restrict:"A",transclude:!0,scope:{mlDuration:"="},link:n}}function n(t,e,n,s,a){t.$watch("mlDuration",function(e,n){e&&angular.extend(t,{duration:r(e)})}),a(t,function(t){e.append(t)})}function r(t){var e=["P(","(([0-9]*\\.?[0-9]*)Y)?","(([0-9]*\\.?[0-9]*)M)?","(([0-9]*\\.?[0-9]*)W)?","(([0-9]*\\.?[0-9]*)D)?",")?","(T","(([0-9]*\\.?[0-9]*)H)?","(([0-9]*\\.?[0-9]*)M)?","(([0-9]*\\.?[0-9]*)S)?",")?"],n=new RegExp(e.join("")),r=t.match(n);return{years:parseFloat(r[3])||null,months:parseFloat(r[5])||null,weeks:parseFloat(r[7])||null,days:parseFloat(r[9])||null,hours:parseFloat(r[12])||null,minutes:parseFloat(r[14])||null,seconds:parseFloat(r[16])||null,toString:function(){return t}}}angular.module("ml.search").filter("duration",t).directive("mlDuration",e)}(),function(){"use strict";function t(){return{restrict:"E",controller:"mlFacetsController",scope:{activeFacets:"=",facets:"=",toggle:"&",negate:"&",showMore:"&"},templateUrl:e,link:n}}function e(t,e){var n;return n=e.template?"inline"===e.template?"/templates/ml-facets-inline.html":e.template:"/templates/ml-facets.html"}function n(t,e,n){t.truncateLength=parseInt(n.truncate)||20,t.shouldShowMore=!!n.showMore,t.shouldNegate=!!n.negate&&!!n.activeFacets}function r(t,e){t.filter=e("filter")}angular.module("ml.search").directive("mlFacets",t).controller("mlFacetsController",["$scope","$filter",r])}(),function(){"use strict";function t(){return{restrict:"E",scope:{qtext:"=",search:"&",suggest:"&"},templateUrl:e,link:n}}function e(t,e){var n;return n=e.template?"fa"===e.template?"/templates/ml-input-fa.html":e.template:"/templates/ml-input.html"}function n(t,e){t.clear=function(){t.search({qtext:""})}}angular.module("ml.search").directive("mlInput",t)}(),function(){"use strict";function t(t){return r=t,{restrict:"E",replace:!0,transclude:!0,templateUrl:"/templates/ml-metrics.html",scope:{search:"=",showDuration:"=?"},link:e}}function e(t,e,r,s,a){void 0===t.showDuration&&(t.showDuration=!0),t.$watch("search",function(e){angular.extend(t,n(e))}),a(t,function(t){t.length&&e.replaceWith(t)})}function n(t){return{total:t.total,start:t.start,pageLength:t["page-length"],pageEnd:r.Math.min(t.start+t["page-length"]-1,t.total),metrics:t.metrics}}angular.module("ml.search").directive("mlMetrics",t);var r=null;t.$inject=["$window"]}(),function(){"use strict";function t(){return{restrict:"E",controller:"MLRemoteInputController",scope:{searchCtrl:"@",template:"@"},template:e}}function e(t,e){var n="";return e.template&&(n=' template="'+e.template+'"'),'<ml-input qtext="qtext" search="search(qtext)" suggest="suggest(val)"'+n+"></ml-input>"}function n(t,e,n,r){var s,a=n.newContext();t.qtext=r.input,r.initInput(t,a),t.$watch("searchCtrl",function(e){var n=s;e=e||"SearchCtrl",s=r.getPath(e),n&&s!==n&&t.search("")}),t.search=function(t){e.path(s),r.setInput(t)},t.suggest=function(t){return a=r.mlSearch||a,a.suggest(t).then(function(t){return t.suggestions||[]})}}angular.module("ml.search").directive("mlRemoteInput",t).controller("MLRemoteInputController",n),n.$inject=["$scope","$location","MLSearchFactory","MLRemoteInputService"]}(),function(){"use strict";function t(){return{restrict:"E",scope:{results:"=",link:"&",label:"&"},templateUrl:e,link:n}}function e(t,e){var n;return n=e.template?e.template:"/templates/ml-results.html"}function n(t,e,n){n.link||(t.link=function(t){return"/detail?uri="+encodeURIComponent(t.result.uri)}),n.label||(t.label=function(t){return _.last(t.result.uri.split("/"))}),t.$watch("results",function(e,n){_.each(e,function(e){e.link=t.link({result:e}),e.label=t.label({result:e})})})}angular.module("ml.search").directive("mlResults",t)}(),function(){"use strict";function t(t){function e(t){n.callbacks.splice(t)}var n=this,r=null;this.routeAvailable=!0;try{r=t.get("$route")}catch(s){this.routeAvailable=!1}n.input="",n.mlSearch=null,n.callbacks=[],n.setInput=function(t){n.input=t,_.each(n.callbacks,function(t){t(n.input)})},n.subscribe=function(t){var r=n.callbacks.length;return n.callbacks.push(t),function(){e(r)}},n.initInput=function(t,e){var r=n.subscribe(function(r){t.qtext=r,e=n.mlSearch||e});t.$on("destroy",r)},n.initCtrl=function(t,e,r,s){var a=n.subscribe(function(t){e.qtext!==t&&(e.qtext=t,s())});t.$on("$destroy",a),n.mlSearch=r,e.qtext.length&&!n.input.length?n.setInput(e.qtext):e.qtext=n.input},n.getPath=function(t){var e={originalPath:"/"},n=null;return null===r?null:(n=_.where(r.routes,{controller:t}),0===n.length?console.error("can't find Search controller: "+t):(e=n[0],n.length>1&&console.log("multiple Search controller routes; choosing '"+e.originalPath+"'")),e.originalPath)}}angular.module("ml.search").service("MLRemoteInputService",t),t.$inject=["$injector"]}(),function(){"use strict";function t(t,n,r,s){return o=t,u=n,c=r,l=s,{newContext:function(t){return new e(t)}}}function e(t){this.qb=l,this.results={},this.storedOptions={},this.activeFacets={},this.namespaces={},this.boostQueries=[],this.additionalQueries=[],this.searchTransform=null,this.qtext=null,this.start=1,this.options=_.merge(_.cloneDeep(this.defaults),t)}function n(t){return decodeURIComponent(t.replace(/\+/g,"%20"))}function r(t,e){function n(t){var e=document.createElement("a");return e.href=t,e.pathname}return n(t)===n(e)}function s(t,e){return t&&t.options&&t.options.constraint&&_.where(i(t.options.constraint),{name:e})[0]}function a(t){var e={constraint:i(t),values:i(_.cloneDeep(t))};return e.values[0]["values-option"]=t.range&&t.range["facet-option"],e}function i(){var t;return t=1===arguments.length?Array.isArray(arguments[0])?arguments[0]:[arguments[0]]:[].slice.call(arguments)}var o=null,u=null,c=null,l=null;angular.module("ml.search").factory("MLSearchFactory",t),t.$inject=["$q","$location","MLRest","MLQueryBuilder"],angular.extend(e.prototype,{defaults:{queryOptions:"all",suggestOptions:null,pageLength:10,snippet:"compact",sort:null,facetMode:"and",includeProperties:!1,includeAggregates:!1,params:{separator:":",qtext:"q",facets:"f",negatedFacets:"n",sort:"s",page:"p",prefix:null,prefixSeparator:null}},getActiveFacets:function(){return this.activeFacets},getNamespacePrefix:function(t){return this.namespaces[t]},getNamespaceUri:function(t){return _.chain(this.namespaces).map(function(e,n){return t===e?n:void 0}).compact().first().value()},getNamespaces:function(){var t=[];return _.forIn(this.namespaces,function(e,n){t.push({prefix:e,uri:n})}),t},setNamespaces:function(t){return _.each(t,this.addNamespace,this),this},addNamespace:function(t){return this.namespaces[t.uri]=t.prefix,this},clearNamespaces:function(){return this.namespaces={},this},getBoostQueries:function(){return this.boostQueries},addBoostQuery:function(t){return this.boostQueries.push(t),this},clearBoostQueries:function(){return this.boostQueries=[],this},getAdditionalQueries:function(){return this.additionalQueries},addAdditionalQuery:function(t){return this.additionalQueries.push(t),this},clearAdditionalQueries:function(){return this.additionalQueries=[],this},getTransform:function(t){return this.searchTransform},setTransform:function(t){return this.searchTransform=t,this},getText:function(){return this.qtext},setText:function(t){return""!==t?this.qtext=t:this.qtext=null,this},getPage:function(){var t=Math.floor(this.start/this.options.pageLength)+1;return t},setPage:function(t){return t=parseInt(t)||1,this.start=1+(t-1)*this.options.pageLength,this},getQueryOptions:function(){return this.options.queryOptions},getSuggestOptions:function(){return this.options.suggestOptions},getPageLength:function(){return this.options.pageLength},setPageLength:function(t){return this.options.pageLength=t,this},getSnippet:function(){return this.options.snippet},setSnippet:function(t){return this.options.snippet=t,this},clearSnippet:function(){return this.options.snippet=this.defaults.snippet,this},getSort:function(){return this.options.sort},setSort:function(t){return this.options.sort=t,this},clearSort:function(){return this.options.sort=this.defaults.sort,this},getFacetMode:function(){return this.options.facetMode},setFacetMode:function(t){return this.options.facetMode=t,this},getParamsConfig:function(){return this.options.params},getParamsKeys:function(){var t=this.getParamsPrefix();return _.chain(this.options.params).omit(["separator","prefix","prefixSeparator"]).map(function(e){return t+e}).compact().value()},getParamsPrefix:function(){var t="";return null!==this.options.params.prefix&&(t=this.options.params.prefix+(this.options.params.prefixSeparator||this.options.params.separator)),t},getQuery:function(){var t=l.and();return _.keys(this.activeFacets).length&&(t=this.getFacetQuery()),this.boostQueries.length&&(t=l.boost(t,this.boostQueries)),this.additionalQueries.length&&(t=l.and(t,this.additionalQueries)),this.options.includeProperties&&(t=l.or(t,l.propertiesFragment(t))),t=l.where(t),this.options.sort&&t.query.queries.push(l.ext.operatorState("sort",this.options.sort)),this.options.snippet&&t.query.queries.push(l.ext.operatorState("results",this.options.snippet)),t},getFacetQuery:function(){var t,e=this,n=[],r={};return _.forIn(e.activeFacets,function(e,r){e.values.length&&(t=function(t){var n=l.ext.constraint(e.type)(r,t.value);return t.negated===!0&&(n=l.not(n)),n},n=n.concat(_.map(e.values,t)))}),r="or"===e.options.facetMode?l.or(n):l.and(n)},getCombinedQuerySync:function(t){return l.ext.combined(this.getQuery(),this.getText(),t)},getCombinedQuery:function(t){var e=this.getCombinedQuerySync();return t?this.getStoredOptions().then(function(t){return e.search.options=t.options,e}):o.resolve(e)},isFacetActive:function(t,e){var n=this.activeFacets[t];return!!n&&!!_.find(n.values,{value:e})},isFacetNegated:function(t,e){var n=this.activeFacets[t];if(!n)return!1;var r=_.find(n.values,{value:e});return r?r.negated:!1},selectFacet:function(t,e,n,r){/^"(.*)"$/.test(e)&&(e=e.replace(/^"(.*)"$/,"$1"));var s=this.activeFacets[t],a=r||!1,i={value:e,negated:a};return s&&!this.isFacetActive(t,e)?s.values.push(i):this.activeFacets[t]={type:n,values:[i]},this},clearFacet:function(t,e){var n=this.activeFacets[t];return n.values=_.filter(n.values,function(t){return t.value!==e}),n.values.length||delete this.activeFacets[t],this},toggleFacet:function(t,e,n){var r;return this.isFacetActive(t,e)?this.clearFacet(t,e):(r=this.getFacetConfig(t),this.selectFacet(t,e,r.type,n)),this},clearAllFacets:function(){return this.activeFacets={},this},showMoreFacets:function(t,e,n){n=n||5;var r=t.facetValues.length+1,s=r+n-1;return this.valuesFromConstraint(e,{start:r,limit:s}).then(function(e){var n=e&&e["values-response"]&&e["values-response"]["distinct-value"];return t.displayingAll=!n||n.length<s-r,_.each(n,function(e){t.facetValues.push({name:e._value,value:e._value,count:e.frequency})}),t})},getParams:function(){var t=this.getPage(),e=this.getFacetParams(),n=e.facets,r=e.negatedFacets,s={},a=this.getParamsPrefix();return n.length&&null!==this.options.params.facets&&(s[a+this.options.params.facets]=n),r.length&&null!==this.options.params.negatedFacets&&(s[a+this.options.params.negatedFacets]=r),t>1&&null!==this.options.params.page&&(s[a+this.options.params.page]=t),this.qtext&&null!==this.options.params.qtext&&(s[a+this.options.params.qtext]=this.qtext),this.options.sort&&null!==this.options.params.sort&&(s[a+this.options.params.sort]=this.options.sort),s},getFacetParams:function(){var t=this,e=t.getFacetQuery(),n=[],r={facets:[],negatedFacets:[]};return n=(e["or-query"]||e["and-query"]).queries,_.each(n,function(e){var n,s,a,i=_.keys(e)[0];"not-query"===i?(n=e[i][_.keys(e[i])[0]],a=r.negatedFacets):(n=e[i],a=r.facets),s=n["constraint-name"],_.each(n.value||n.uri,function(e){/\s+/.test(e)&&!/^"(.*)"$/.test(e)&&(e='"'+e+'"'),a.push(s+t.options.params.separator+e)})}),r},getCurrentParams:function(t){var e=this.getParamsPrefix();return t=_.pick(t||u.search(),this.getParamsKeys()),_.chain(this.options.params).pick(["facets","negatedFacets"]).values().each(function(n){var r=e+n;t[r]&&(t[r]=i(t[r]))}).value(),t},fromParams:function(t){var e=this,n=this.options.params,r=null,s=null,a=null;return t=this.getCurrentParams(t),this.fromParam(n.qtext,t,this.setText.bind(this),this.setText.bind(this,null)),this.fromParam(n.page,t,this.setPage.bind(this),this.setPage.bind(this,1)),this.fromParam(n.sort,t,this.setSort.bind(this)),e.clearAllFacets(),r=this.fromParam(n.facets,t,_.identity),s=this.fromParam(n.negatedFacets,t,_.identity),r||s?(a=e.results.facets?o.resolve(void 0):e.getStoredOptions(),a.then(function(t){r&&e.fromFacetParam(r,t),s&&e.fromFacetParam(s,t,!0)})):o.resolve()},fromParam:function(t,e,r,s){var a=this.getParamsPrefix()+t,i=e[a];if(null!==t)return i?(_.isString(i)&&(i=n(i)),r.call(this,i)):void(s&&s.call(this))},fromFacetParam:function(t,e,r){var s=this,a=_.map(i(t),n),o=r||!1;_.each(a,function(t){var n=t.split(s.options.params.separator),r=n[0],a=n[1],i=s.getFacetConfig(r,e)||{};i.type||console.error("don't have facets or options for '"+r+"', falling back to un-typed range queries"),s.selectFacet(r,a,i.type,o)})},getFacetConfig:function(t,e){var n=null;return e?(n=_.chain(e.options.constraint).where({name:t}).first().clone().value(),n.type=n.collection?"collection":n.custom?"custom":n.range.type):this.results.facets&&this.results.facets[t]&&(n=this.results.facets[t]),n},locationChange:function(t,e,n){n=this.getCurrentParams(n);var s=r(t,e)&&!_.isEqual(this.getParams(),n);return s?this.fromParams(n):o.reject()},getStoredOptions:function(t){var e=this;return t=t||this.getQueryOptions(),this.storedOptions[t]?o.resolve(this.storedOptions[t]):c.queryConfig(t).then(function(n){return e.storedOptions[t]=n.data,e.storedOptions[t]})},getAllStoredOptions:function(t){var e=this,n={};return o.all(_.map(t,e.getStoredOptions.bind(e))).then(function(){return _.each(t,function(t){n[t]=e.storedOptions[t]}),n})},suggest:function(t,e){var n={"partial-q":t,format:"json",options:_.isString(e)&&e||this.getSuggestOptions()||this.getQueryOptions()},r=this.getCombinedQuerySync();return _.isObject(e)&&(r.search.options=e),c.suggest(n,r).then(function(t){return t.data})},valuesFromConstraint:function(t,e){var n=this;return this.getStoredOptions().then(function(r){var i=s(r,t);if(!i)return o.reject(new Error("No constraint exists matching "+t));if(i.range&&i.range.bucket)return o.reject(new Error("Can't get values for bucketed constraint "+t));var u=a(i);return n.values(t,e,u)})},values:function(t,e,n){var r=this,s=this.getCombinedQuerySync();return n||!e||!e.options||e.start||e.limit||(n=e,e=null),e=e||{},e.start=void 0!==e.start?e.start:1,e.limit=void 0!==e.limit?e.limit:20,e.options=r.getQueryOptions(),_.isObject(n)&&(s.search.options=n),c.values(t,e,s).then(function(t){return t.data})},search:function(t){var e=this,n=null,r=!0,s={start:this.start,pageLength:this.options.pageLength,transform:this.searchTransform};return t?(n=this.getCombinedQuerySync(),t.search?(r=!1,n.search=t.search):t.options?(r=!1,n.search.options=t.options):t.query?n.search.query=t.query:n.search.options=t):(s.structuredQuery=this.getQuery(),s.q=this.getText()),r&&(s.options=this.getQueryOptions()),c.search(s,n).then(function(t){var r=t.data;return n||(e.results=r),e.transformMetadata(r.results),e.annotateActiveFacets(r.facets),e.options.includeAggregates?e.getAggregates(r.facets).then(function(){return r}):r})},annotateActiveFacets:function(t){var e=this;_.forIn(t,function(t,n){var r=e.activeFacets[n];r&&_.chain(t.facetValues).filter(function(t){return e.isFacetActive(n,t.name)}).each(function(r){t.selected=r.selected=!0,r.negated=e.isFacetNegated(n,r.name)}).value(),"bucketed"===t.type&&(t.displayingAll=!0)})},getAggregates:function(t){var e=this;return e.getStoredOptions().then(function(n){var r=[];try{_.forIn(t,function(t,i){var o=t.type,u=s(n,i);if(!u)throw new Error("No constraint exists matching "+i);var c=a(u);c.values.aggregate=[{apply:"count"},{apply:"min"},{apply:"max"}];var l=["xs:int","xs:unsignedInt","xs:long","xs:unsignedLong","xs:float","xs:double","xs:decimal"];_.contains(l,o)&&(c.values.aggregate=c.values.aggregate.concat([{apply:"sum"},{apply:"avg"}])),r.push(e.values(i,{start:1,limit:0},c).then(function(e){var n=e&&e["values-response"]&&e["values-response"]["aggregate-result"];_.each(n,function(e){t[e.name]=e._value})}))})}catch(i){return o.reject(i)}return o.all(r)})},transformMetadata:function(t){var e,n=this;return _.isArray(t)?void _.each(t,this.transformMetadata,n):(e=t.metadata,t.metadata={},void _.each(e,function(e){var r=_.without(_.keys(e),"metadata-type")[0],s=e["metadata-type"],a=e[r],i=null,o=null,u=null;u=r.replace(/^\{([^}]+)\}.*$/,"$1"),o=n.getNamespacePrefix(u),i=o?r.replace(/\{[^}]+\}/,o+":"):r,t.metadata[i]||(t.metadata[i]={"metadata-type":s,values:[]}),t.metadata[i].values.push(a)}))},getStructuredQuery:function(){return console.log("Warning, MLSearchContext.getStructuredQuery is deprecated, and will be removed in the next release!\nUse MLSearchContext.getQuery in it's place"),this.getQuery.apply(this,arguments)},serializeStructuredQuery:function(){return console.log("Warning, MLSearchContext.serializeStructuredQuery is deprecated, and will be removed in the next release!\nUse MLSearchContext.getParams in it's place"),this.getParams.apply(this,arguments)}})}();