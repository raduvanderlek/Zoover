# Zoover PoC Application

This application was generated by the MarkLogic-Node [Slush](https://github.com/klei/slush) generator, with the following components:

- [AngularJS](https://angularjs.org/)
- [Gulp](http://gulpjs.com/)
- [node.js](http://nodejs.org/): very thin layer, hosting the Angular code and proxying MarkLogic REST API requests
- [Roxy Deployer](https://github.com/marklogic/roxy): bootstrap MarkLogic databases, application servers, etc; scaffolding for MarkLogic REST API service extensions

## Install Required Dependencies

- [node.js](http://nodejs.org/download/)
- [npm](https://www.npmjs.com/): Built-in package manager for node (comes with
  node, but check to be sure you have latest version: `npm install -g npm`)
- [gulp](http://gulpjs.com/): Javascript task automation (`npm install -g
  gulp`)
- [Bower](http://bower.io/): A package manager for front-end libraries (`npm
  install -g bower`)
- [Git](https://git-scm.com/) - Roxy depends on this version control system
- [Ruby](https://www.ruby-lang.org/en/documentation/installation/) - Roxy
  depends on Ruby in order to run server configuration scripts

# Running the application

    ./ml local bootstrap
    ./ml local deploy modules

On Windows, that would be:

    ml.bat local bootstrap
    ml.bat local deploy modules

Install additional dependencies using the bower package manager:

    bower install
	
If you want to upload a dictionary for spell-suggestions:

    ./ml local deploy content

On Windows:

    ml.bat local deploy content

Edit `./local.json` to set your desired ports

    gulp serve-local # this will watch the .less file for changes, compile them to .css, and run the node server

# Installing as service

The code includes a service script, and a service config to make installing express server service as easy as possible. The following files are involved:

- etc/init.d/node-express-service (generic express server service script)
- etc/{app}/conf.sh (application specific service configuration, any application name allowed)
- boot.js (entry point for express service, calls out to server.js)
- node-app.js (required by boot.js)

The conf.sh is 'sourced' by the service script, and allows overriding the built-in defaults. Usually you only need to override SOURCE\_DIR, APP\_PORT, and ML\_PORT. Make sure they match the appropriate environment.

Next install [forever](https://www.npmjs.com/package/forever) globally if it is not already installed.

- `$ [sudo] npm install forever -g`

Next, push all source files to the appropriate server. The following assumes it was dropped under /space/projects/ in a folder called slush-app.live. Take these steps to install the services:

- cd /space/projects/slush-app.live
- gulp build # this will create the ./dist/ folder with all the required assests and code
- cd /etc
- sudo ln -s /space/projects/slush-app.live/etc/{env} slush-app
- cd /etc/init.d
- sudo ln -s /space/projects/slush-app.live/etc/init.d/node-express-service slush-app
- sudo chkconfig --add slush-app
- sudo chkconfig --levels 2345 slush-app on

Next to start it, use the following commands (from any directory):

- sudo service slush-app start

These services will also print usage without param, but they support info, restart, start, status, and stop. The info param is very useful to check the settings.

# Data

## Loading data through mlcp

Mlcp is MarkLogic's bulk load tool to load data from json, xml, triple, csv, binary and text files.

You can get it from https://developer.marklogic.com/products/mlcp. Make sure you install it so that Roxy can find it (check the attribute 'mlcp-home' in ./deploy/default.properties)

### Ingest json files from a directory

Suppose you have json files in the directory /zoover/incoming and want to ingest them into MarkLogic. Just call the following command:

- ml local mlcp IMPORT -input_file_path /zoover/incoming

If you want to load it into a collection 'test' run this:

- ml local mlcp IMPORT -input_file_path /zoover/incoming -output_collections test

### Example to load

- ./ml mlcp local IMPORT -input_file_path ./ZooverData/CriteoStats_20150901_20150930.json -output_collections data

## Loading data through REST

The MarkLogic REST endpoint for this instance can be found at http://localhost:10040.
Documents can be ingested by calling a PUT on /v1/documents and retrieved by GETting from /v1/documents. You can use a tool like Postman to try this out.

### Ingest example (PUT)

We want to ingest a JSON file to the database, give it an URI of 'test.json' and place it in the collection 'test'.

The way to do this is by calling PUT on the following URL:

- http://localhost:10040/v1/documents

And passing the following URL parameters:

- uri=/test.json
- collection=test

And passing the following header(s):

- Content-Type: application/json
- Optionally the digest Authorization header related to your credentials of MarkLogic

### Retrieval example (GET)

We want to retrieve the just inserted document.

The way to do this is by calling GET on the following URL:

- http://localhost:10040/v1/documents

And passing the following URL parameters:

- uri=/test.json

And passing the following header(s):

- Accept: application/json
- Optionally the digest Authorization header related to your credentials of MarkLogic

### Search example (GET)

We want to search for documents within the database that corresponds to the ingested JSON file.

The way to do this is by calling GET on the following URL:

- http://localhost:10040/v1/search

And passing the following URL parameters:

- q=test (where test is the string to search for)
- Optionally limit to a collection: collection=test

And passing the following header(s):

- Accept: application/json
- Optionally the digest Authorization header related to your credentials of MarkLogic
